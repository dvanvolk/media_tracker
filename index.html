<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Tracker</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Lucide Icons as inline SVG
        const Film = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect>
                <line x1="7" y1="2" x2="7" y2="22"></line>
                <line x1="17" y1="2" x2="17" y2="22"></line>
                <line x1="2" y1="12" x2="22" y2="12"></line>
                <line x1="2" y1="7" x2="7" y2="7"></line>
                <line x1="2" y1="17" x2="7" y2="17"></line>
                <line x1="17" y1="17" x2="22" y2="17"></line>
                <line x1="17" y1="7" x2="22" y2="7"></line>
            </svg>
        );

        const Tv = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect>
                <polyline points="17 2 12 7 7 2"></polyline>
            </svg>
        );

        const Disc = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <circle cx="12" cy="12" r="3"></circle>
            </svg>
        );

        const Search = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
        );

        const AlertCircle = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
        );

        const RefreshCw = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
        );

        const X = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        );

        const API_URL = '/api';

        const MediaTrackerGUI = () => {
            const [stats, setStats] = useState({
                movies: 0,
                series: 0,
                dvds: 0
            });

            const [barcode, setBarcode] = useState('');
            const [lastScanned, setLastScanned] = useState(null);
            const [scanning, setScanning] = useState(false);
            const [syncing, setSyncing] = useState(false);
            const [error, setError] = useState('');

            // Verification state
            const [verificationData, setVerificationData] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            const [searchType, setSearchType] = useState('movie');
            const [searchResults, setSearchResults] = useState([]);
            const [searching, setSearching] = useState(false);
            const [confirming, setConfirming] = useState(false);

            useEffect(() => {
                loadStats();
                const interval = setInterval(loadStats, 5000);
                return () => clearInterval(interval);
            }, []);

            const loadStats = async () => {
                try {
                    const response = await fetch(`${API_URL}/stats`);
                    if (!response.ok) throw new Error('Failed to load stats');
                    const data = await response.json();
                    setStats(data);
                } catch (err) {
                    console.error('Error loading stats:', err);
                }
            };

            const handleLookup = async () => {
                if (!barcode.trim()) return;

                setScanning(true);
                setError('');

                try {
                    const response = await fetch(`${API_URL}/lookup`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ barcode: barcode.trim() }),
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        setError(data.error || 'Failed to lookup barcode');
                        return;
                    }

                    setVerificationData(data);
                    setSearchQuery(data.suggested_title || '');
                    setSearchType(data.suggested_type || 'movie');
                    setSearchResults(data.suggested_type === 'movie' ? data.movie_results : data.series_results);
                } catch (err) {
                    setError('Failed to connect to server. Make sure the Flask backend is running.');
                    console.error('Lookup error:', err);
                } finally {
                    setScanning(false);
                }
            };

            const handleManualSearch = async () => {
                if (!searchQuery.trim()) return;

                setSearching(true);
                setError('');

                try {
                    const response = await fetch(`${API_URL}/search`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            query: searchQuery.trim(),
                            type: searchType
                        }),
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        setError(data.error || 'Failed to search');
                        return;
                    }

                    setSearchResults(data.results);
                } catch (err) {
                    setError('Failed to search');
                    console.error('Search error:', err);
                } finally {
                    setSearching(false);
                }
            };

            const handleConfirm = async (item) => {
                setConfirming(true);
                setError('');

                try {
                    const response = await fetch(`${API_URL}/confirm`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            barcode: verificationData.barcode,
                            type: searchType,
                            item: item
                        }),
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        setError(data.error || 'Failed to add item');
                        return;
                    }

                    await loadStats();

                    setLastScanned({
                        title: data.item.title,
                        type: data.item.type,
                        year: data.item.year,
                        timestamp: new Date().toLocaleTimeString(),
                        updated: data.updated || false
                    });

                    // Reset form
                    setBarcode('');
                    setVerificationData(null);
                    setSearchQuery('');
                    setSearchResults([]);
                } catch (err) {
                    setError('Failed to add item');
                    console.error('Confirm error:', err);
                } finally {
                    setConfirming(false);
                }
            };

            const handleCancel = () => {
                setBarcode('');
                setVerificationData(null);
                setSearchQuery('');
                setSearchResults([]);
                setError('');
            };

            const handleSync = async () => {
                setSyncing(true);
                setError('');

                try {
                    const response = await fetch(`${API_URL}/sync`, {
                        method: 'POST',
                    });

                    if (!response.ok) throw new Error('Sync failed');

                    await loadStats();
                    setError('');
                } catch (err) {
                    setError('Failed to sync with Radarr/Sonarr');
                    console.error('Sync error:', err);
                } finally {
                    setSyncing(false);
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter') {
                    if (verificationData) {
                        handleManualSearch();
                    } else {
                        handleLookup();
                    }
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-8">
                    <div className="max-w-6xl mx-auto">
                        <div className="text-center mb-8">
                            <h1 className="text-4xl font-bold text-white mb-2">Media Tracker</h1>
                            <p className="text-purple-300">Track your DVD collection</p>
                            <button
                                onClick={handleSync}
                                disabled={syncing}
                                className="mt-4 px-4 py-2 bg-purple-600/50 hover:bg-purple-600 text-white rounded-lg transition-colors duration-200 flex items-center gap-2 mx-auto disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                <RefreshCw className={`w-4 h-4 ${syncing ? 'animate-spin' : ''}`} />
                                {syncing ? 'Syncing...' : 'Sync Libraries'}
                            </button>
                        </div>

                        {!verificationData ? (
                            <>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                    <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 shadow-xl transform hover:scale-105 transition-transform duration-200">
                                        <div className="flex items-center justify-between mb-4">
                                            <Film className="w-12 h-12 text-blue-400" />
                                            <span className="text-5xl font-bold text-white">{stats.movies}</span>
                                        </div>
                                        <h3 className="text-xl font-semibold text-white">Movies</h3>
                                        <p className="text-purple-300 text-sm">Total in library</p>
                                    </div>

                                    <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 shadow-xl transform hover:scale-105 transition-transform duration-200">
                                        <div className="flex items-center justify-between mb-4">
                                            <Tv className="w-12 h-12 text-green-400" />
                                            <span className="text-5xl font-bold text-white">{stats.series}</span>
                                        </div>
                                        <h3 className="text-xl font-semibold text-white">TV Shows</h3>
                                        <p className="text-purple-300 text-sm">Total in library</p>
                                    </div>

                                    <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 shadow-xl transform hover:scale-105 transition-transform duration-200">
                                        <div className="flex items-center justify-between mb-4">
                                            <Disc className="w-12 h-12 text-purple-400" />
                                            <span className="text-5xl font-bold text-white">{stats.dvds}</span>
                                        </div>
                                        <h3 className="text-xl font-semibold text-white">Physical DVDs</h3>
                                        <p className="text-purple-300 text-sm">Scanned copies</p>
                                    </div>
                                </div>

                                <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-8 border border-white/20 shadow-xl mb-8">
                                    <h2 className="text-2xl font-bold text-white mb-4 flex items-center gap-2">
                                        <Search className="w-6 h-6" />
                                        Scan New DVD
                                    </h2>

                                    <div className="space-y-4">
                                        <div>
                                            <input
                                                type="text"
                                                value={barcode}
                                                onChange={(e) => setBarcode(e.target.value)}
                                                onKeyPress={handleKeyPress}
                                                placeholder="Enter or scan barcode..."
                                                className="w-full px-4 py-3 bg-white/5 border border-white/20 rounded-lg text-white placeholder-purple-300 focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                disabled={scanning}
                                                autoFocus
                                            />
                                        </div>

                                        <button
                                            onClick={handleLookup}
                                            disabled={scanning || !barcode.trim()}
                                            className="w-full bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200"
                                        >
                                            {scanning ? 'Looking up...' : 'Lookup Barcode'}
                                        </button>
                                    </div>

                                    {error && (
                                        <div className="mt-4 p-4 bg-red-500/20 border border-red-500/50 rounded-lg flex items-center gap-2 text-red-200">
                                            <AlertCircle className="w-5 h-5 flex-shrink-0" />
                                            <span>{error}</span>
                                        </div>
                                    )}
                                </div>

                                {lastScanned && (
                                    <div className="bg-gradient-to-r from-purple-500/20 to-blue-500/20 backdrop-blur-lg rounded-2xl p-6 border border-white/20 shadow-xl">
                                        <h3 className="text-lg font-semibold text-purple-300 mb-2">
                                            ✓ {lastScanned.updated ? 'Updated Physical Copy' : 'Last Scanned'}
                                        </h3>
                                        <p className="text-2xl font-bold text-white mb-1">{lastScanned.title}</p>
                                        <p className="text-sm text-purple-300">
                                            {lastScanned.type === 'movie' ? 'Movie' : 'TV Show'} • {lastScanned.year} • {lastScanned.timestamp}
                                        </p>
                                    </div>
                                )}
                            </>
                        ) : (
                            <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-8 border border-white/20 shadow-xl">
                                <div className="flex items-center justify-between mb-6">
                                    <h2 className="text-2xl font-bold text-white">Verify & Select</h2>
                                    <button
                                        onClick={handleCancel}
                                        className="text-white hover:text-red-400 transition-colors"
                                    >
                                        <X className="w-6 h-6" />
                                    </button>
                                </div>

                                {verificationData.suggested_title && (
                                    <div className="mb-4 p-4 bg-blue-500/20 border border-blue-500/50 rounded-lg">
                                        <p className="text-blue-200 text-sm">Barcode lookup found:</p>
                                        <p className="text-white font-semibold">{verificationData.suggested_title}</p>
                                    </div>
                                )}

                                <div className="space-y-4 mb-6">
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => setSearchType('movie')}
                                            className={`flex-1 py-2 px-4 rounded-lg transition-colors ${
                                                searchType === 'movie'
                                                    ? 'bg-blue-600 text-white'
                                                    : 'bg-white/5 text-purple-300 hover:bg-white/10'
                                            }`}
                                        >
                                            Movie
                                        </button>
                                        <button
                                            onClick={() => setSearchType('series')}
                                            className={`flex-1 py-2 px-4 rounded-lg transition-colors ${
                                                searchType === 'series'
                                                    ? 'bg-green-600 text-white'
                                                    : 'bg-white/5 text-purple-300 hover:bg-white/10'
                                            }`}
                                        >
                                            TV Show
                                        </button>
                                    </div>

                                    <div className="flex gap-2">
                                        <input
                                            type="text"
                                            value={searchQuery}
                                            onChange={(e) => setSearchQuery(e.target.value)}
                                            onKeyPress={handleKeyPress}
                                            placeholder="Search for title..."
                                            className="flex-1 px-4 py-3 bg-white/5 border border-white/20 rounded-lg text-white placeholder-purple-300 focus:outline-none focus:ring-2 focus:ring-purple-500"
                                        />
                                        <button
                                            onClick={handleManualSearch}
                                            disabled={searching || !searchQuery.trim()}
                                            className="px-6 py-3 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-semibold rounded-lg transition-colors"
                                        >
                                            {searching ? 'Searching...' : 'Search'}
                                        </button>
                                    </div>
                                </div>

                                {error && (
                                    <div className="mb-4 p-4 bg-red-500/20 border border-red-500/50 rounded-lg flex items-center gap-2 text-red-200">
                                        <AlertCircle className="w-5 h-5 flex-shrink-0" />
                                        <span>{error}</span>
                                    </div>
                                )}

                                <div className="space-y-2 max-h-96 overflow-y-auto">
                                    {searchResults.length === 0 ? (
                                        <p className="text-purple-300 text-center py-8">No results found. Try a different search.</p>
                                    ) : (
                                        searchResults.map((item, index) => (
                                            <div
                                                key={index}
                                                className="bg-white/5 hover:bg-white/10 border border-white/20 rounded-lg p-4 cursor-pointer transition-colors"
                                                onClick={() => handleConfirm(item)}
                                            >
                                                <div className="flex items-start justify-between">
                                                    <div className="flex-1">
                                                        <div className="flex items-center gap-2 mb-1">
                                                            <h3 className="text-white font-semibold">{item.title}</h3>
                                                            {item.already_in_library && (
                                                                <span className="px-2 py-1 bg-green-500/20 border border-green-500/50 text-green-300 text-xs rounded">
                                                                    In Library
                                                                </span>
                                                            )}
                                                        </div>
                                                        <p className="text-purple-300 text-sm">
                                                            {item.year} • {searchType === 'movie' ? 'Movie' : 'TV Show'}
                                                        </p>
                                                        {item.overview && (
                                                            <p className="text-purple-200 text-sm mt-2 line-clamp-2">
                                                                {item.overview}
                                                            </p>
                                                        )}
                                                    </div>
                                                    {item.remotePoster && (
                                                        <img
                                                            src={item.remotePoster}
                                                            alt={item.title}
                                                            className="w-16 h-24 object-cover rounded ml-4"
                                                        />
                                                    )}
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>

                                {confirming && (
                                    <div className="mt-4 text-center text-purple-300">
                                        Adding to library...
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<MediaTrackerGUI />, document.getElementById('root'));
    </script>
</body>
</html>